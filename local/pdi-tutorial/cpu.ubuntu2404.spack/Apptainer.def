Bootstrap: docker
From: spack/ubuntu-noble:latest
Stage: build

%post
  # Create the manifest file for the installation in /opt/spack-environment
  mkdir /opt/spack-environment && cd /opt/spack-environment
  cat << EOF > spack.yaml
spack:
  view: /opt/views/view
  concretizer:
    unify: true
  # add package specs to the `specs` list
  specs:
  - cmake
  - kokkos
  - pdi~fortran
  - pdiplugin-decl-hdf5
  - pdiplugin-mpi
  - pdiplugin-pycall
  - pdiplugin-trace
  - pdiplugin-user-code
  - pdiplugin-set-value
  - python+tkinter
  - py-dask
  - py-distributed
  - py-bokeh
  - py-matplotlib
  - py-mpi4py
  - py-pip
  - py-pytest
  - git
  - gdb
  - gcc
  #config:
  #  install_tree: /opt/software
  packages:
    gcc:
      externals:
      - spec: gcc@13.3.0 languages:='c,c++,fortran'
        prefix: /usr
        extra_attributes:
          compilers:
            c: /usr/bin/gcc
            cxx: /usr/bin/g++
            fortran: /usr/bin/gfortran
      - spec: gcc@13.3.0 languages:='c,c++'
        prefix: /usr
        extra_attributes:
          compilers:
            c: /usr/bin/gcc
            cxx: /usr/bin/g++
    binutils:
      externals:
      - spec: binutils@2.42+gold~headers
        prefix: /usr
    gettext:
      externals:
      - spec: gettext@0.21
        prefix: /usr
    perl:
      externals:
      - spec: perl@5.38.2~cpanm+opcode+open+shared+threads
        prefix: /usr
    findutils:
      externals:
      - spec: findutils@4.9.0
        prefix: /usr
    gmake:
      externals:
      - spec: gmake@4.3
        prefix: /usr
    groff:
      externals:
      - spec: groff@1.23.0
        prefix: /usr
    coreutils:
      externals:
      - spec: coreutils@9.4
        prefix: /usr
    openssh:
      externals:
      - spec: openssh@9.6p1
        prefix: /usr
    openssl:
      externals:
      - spec: openssl@3.0.13
        prefix: /usr
    git:
      externals:
      - spec: git@2.43.0~tcltk
        prefix: /usr
    sed:
      externals:
      - spec: sed@4.9
        prefix: /usr
    pkgconf:
      externals:
      - spec: pkgconf@1.8.1
        prefix: /usr
    diffutils:
      externals:
      - spec: diffutils@3.10
        prefix: /usr
    tar:
      externals:
      - spec: tar@1.35
        prefix: /usr
    curl:
      externals:
      - spec: curl@8.5.0+gssapi+ldap+nghttp2
        prefix: /usr
  mirrors:
    numpex-spack-mirror:
      url: oci://ghcr.io/thomas-bouvier/numpex-spack-mirror
      access_pair:
        id_variable: OCI_USERNAME_VARIABLE
        secret_variable: OCI_PASSWORD_VARIABLE
EOF

  # Install all the required software
  . /opt/spack/share/spack/setup-env.sh
  spack -e . concretize
  spack -e . install
  spack gc -y
  spack env activate --sh -d . >> /opt/spack-environment/environment_modifications.sh

  # Strip the binaries to reduce the size of the image
  find -L /opt/views/view/* -type f -exec readlink -f '{}' \; | \
    xargs file -i | \
    grep 'charset=binary' | \
    grep 'x-executable\|x-archive\|x-sharedlib' | \
    awk -F: '{print $1}' | xargs strip

Bootstrap: docker
From: ubuntu:24.04
Stage: final

%files from build
  /opt/spack-environment /opt
  /opt/software /opt
  /opt/views /opt
  /opt/spack-environment/environment_modifications.sh /opt/spack-environment/environment_modifications.sh

%post

  # Symlink the old view location
  ln -s /opt/views/view /opt/view

  # Modify the environment without relying on sourcing shell specific files at startup
  cat /opt/spack-environment/environment_modifications.sh >> $SINGULARITY_ENVIRONMENT

